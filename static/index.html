<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FittingFlow - æç®€å·¥ä½œæµ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        html, body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 100%;
            overflow: hidden;
        }
        
        .container {
            display: flex;
            flex-direction: column;
            height: 100%;
            padding: 10px;
            box-sizing: border-box;
        }
        
        .header {
            text-align: center;
            color: white;
            margin-bottom: 10px;
            flex-shrink: 0;
        }
        
        .header h1 {
            font-size: 1.8rem;
            margin-bottom: 5px;
        }
        
        .header p {
            font-size: 0.9rem;
            opacity: 0.9;
        }
        
        .main-content {
            display: flex;
            flex: 1;
            gap: 10px;
            min-height: 0;
        }
        
        .panel {
            background: white;
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .panel-left {
            width: 220px;
            flex-shrink: 0;
        }
        
        .panel-center {
            flex: 1;
            min-width: 0;
        }
        
        .panel-right {
            width: 180px;
            flex-shrink: 0;
        }
        
        .panel-agent {
            width: 300px;
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
        }
        
        .section-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 15px;
            color: #333;
            padding-bottom: 10px;
            border-bottom: 2px solid #f0f0f0;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.2s;
            width: 100%;
        }
        
        .btn-primary {
            background: #667eea;
            color: white;
        }
        
        .btn-primary:hover {
            background: #5a6fd6;
        }
        
        .btn-secondary {
            background: #f0f0f0;
            color: #333;
        }
        
        .input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 0.9rem;
            margin-bottom: 10px;
        }
        
        .input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .workflow-list {
            list-style: none;
            margin-top: 10px;
            overflow-y: auto;
            flex: 1;
        }
        
        .workflow-item {
            padding: 12px;
            border-radius: 8px;
            background: #f8f9fa;
            margin-bottom: 8px;
            cursor: pointer;
        }
        
        .workflow-item:hover {
            background: #e9ecef;
        }
        
        .workflow-item.active {
            background: #667eea;
            color: white;
        }
        
        /* èŠ‚ç‚¹åº“ */
        .node-template {
            padding: 12px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 8px;
            cursor: grab;
            margin-bottom: 10px;
            user-select: none;
        }
        
        .node-template:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }
        
        /* ç”»å¸ƒ */
        .canvas {
            background: #f8f9fa;
            background-image: 
                radial-gradient(circle, #ddd 1px, transparent 1px);
            background-size: 20px 20px;
            border-radius: 8px;
            flex: 1;
            position: relative;
            overflow: hidden;
            min-height: 0;
            cursor: grab;
        }
        
        .canvas.panning {
            cursor: grabbing;
        }
        
        .canvas-content {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            transform-origin: 0 0;
        }
        
        .zoom-controls {
            position: absolute;
            bottom: 10px;
            right: 10px;
            display: flex;
            gap: 5px;
            z-index: 100;
        }
        
        .zoom-btn {
            width: 32px;
            height: 32px;
            border: none;
            border-radius: 6px;
            background: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            cursor: pointer;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .zoom-btn:hover {
            background: #f0f0f0;
        }
        
        .zoom-level {
            width: 50px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: white;
            border-radius: 6px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            font-size: 0.8rem;
            font-weight: 500;
        }
        
        /* å·¥ä½œæµèŠ‚ç‚¹ */
        .workflow-node {
            position: absolute;
            min-width: 150px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
            cursor: move;
        }
        
        .workflow-node.selected {
            box-shadow: 0 0 0 3px #667eea, 0 6px 20px rgba(0,0,0,0.25);
        }
        
        .node-header {
            padding: 12px 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 12px 12px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .node-title {
            font-weight: 600;
            font-size: 0.9rem;
        }
        
        .node-delete {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1rem;
            line-height: 1;
        }
        
        .node-body {
            padding: 12px 15px;
        }
        
        .node-type-label {
            font-size: 0.75rem;
            color: #666;
            text-transform: uppercase;
        }
        
        /* è¿æ¥ç‚¹ */
        .port {
            position: absolute;
            width: 14px;
            height: 14px;
            background: white;
            border: 3px solid #667eea;
            border-radius: 50%;
            cursor: crosshair;
        }
        
        .port:hover {
            background: #667eea;
        }
        
        .port-input {
            left: -7px;
            top: 50%;
            transform: translateY(-50%);
        }
        
        .port-output {
            right: -7px;
            top: 50%;
            transform: translateY(-50%);
        }
        
        /* SVG è¿çº¿å±‚ */
        .connections-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 100;
        }
        
        .connection-line {
            fill: none;
            stroke: #667eea;
            stroke-width: 3;
            pointer-events: stroke;
            cursor: pointer;
            transition: stroke 0.2s, stroke-width 0.2s;
        }
        
        .connection-line:hover {
            stroke: #764ba2;
            stroke-width: 5;
        }
        
        /* å·¥å…·æ  */
        .toolbar {
            margin-bottom: 10px;
            display: flex;
            gap: 10px;
            flex-shrink: 0;
        }
        
        .toolbar .btn {
            width: auto;
        }
        
        .status-bar {
            margin-top: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            font-family: monospace;
            font-size: 0.8rem;
            max-height: 120px;
            overflow: auto;
            white-space: pre-wrap;
            flex-shrink: 0;
        }
        
        /* å±æ€§é¢æ¿ */
        .property-panel {
            display: none;
        }
        
        .property-panel.visible {
            display: block;
        }
        
        /* ä»£ç ç¼–è¾‘å™¨æ¨¡æ€æ¡† */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .modal-overlay.visible {
            display: flex;
        }
        
        .modal {
            background: white;
            border-radius: 12px;
            padding: 20px;
            width: 600px;
            max-width: 90vw;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        
        .modal-title {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 15px;
            color: #333;
        }
        
        .code-editor {
            width: 100%;
            min-height: 200px;
            font-family: 'Monaco', 'Menlo', 'Consolas', monospace;
            font-size: 0.9rem;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            resize: vertical;
            background: #f8f9fa;
            line-height: 1.5;
        }
        
        .code-editor:focus {
            outline: none;
            border-color: #667eea;
            background: white;
        }
        
        .modal-actions {
            margin-top: 15px;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        
        .modal-hint {
            font-size: 0.8rem;
            color: #666;
            margin-top: 10px;
            padding: 8px;
            background: #f0f0f0;
            border-radius: 6px;
        }
        
        .agent-chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            background: #fafafa;
        }

        .agent-messages {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .agent-message {
            max-width: 90%;
            padding: 10px 14px;
            border-radius: 12px;
            font-size: 0.85rem;
            line-height: 1.5;
            word-break: break-word;
        }

        .agent-message.user {
            align-self: flex-end;
            background: #667eea;
            color: white;
            border-bottom-right-radius: 4px;
        }

        .agent-message.assistant {
            align-self: flex-start;
            background: white;
            color: #333;
            border: 1px solid #e0e0e0;
            border-bottom-left-radius: 4px;
        }

        .agent-message.system {
            align-self: center;
            background: #f0f0f0;
            color: #666;
            font-size: 0.75rem;
            padding: 6px 12px;
        }

        .agent-message.error {
            align-self: center;
            background: #ffebee;
            color: #c62828;
            font-size: 0.8rem;
        }

        .agent-input-area {
            padding: 10px;
            background: white;
            border-top: 1px solid #e0e0e0;
        }

        .agent-input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 0.9rem;
            resize: none;
            min-height: 60px;
            max-height: 120px;
        }

        .agent-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .agent-send-btn {
            width: 100%;
            margin-top: 8px;
            padding: 10px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: background 0.2s;
        }

        .agent-send-btn:hover:not(:disabled) {
            background: #5a6fd6;
        }

        .agent-send-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .agent-status {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.8rem;
            color: #666;
            margin-bottom: 10px;
            padding: 6px 10px;
            background: #f5f5f5;
            border-radius: 6px;
        }

        .agent-status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #ccc;
        }

        .agent-status-dot.online {
            background: #4caf50;
        }

        .agent-status-dot.offline {
            background: #f44336;
        }

        .agent-suggestions {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-bottom: 10px;
        }

        .agent-suggestion {
            padding: 6px 12px;
            background: #f0f0f0;
            border: none;
            border-radius: 16px;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
            color: #555;
        }

        .agent-suggestion:hover {
            background: #667eea;
            color: white;
        }

        .agent-toolbar {
            display: flex;
            gap: 6px;
            margin-bottom: 10px;
        }

        .agent-toolbar button {
            flex: 1;
            padding: 6px;
            background: #f5f5f5;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .agent-toolbar button:hover {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .agent-typing {
            display: flex;
            gap: 4px;
            padding: 10px 14px;
            align-self: flex-start;
        }

        .agent-typing-dot {
            width: 8px;
            height: 8px;
            background: #999;
            border-radius: 50%;
            animation: typing 1.4s infinite;
        }

        .agent-typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .agent-typing-dot:nth-child(3) { animation-delay: 0.4s; }

        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-10px); }
        }

        @media (max-width: 1200px) {
            .panel-agent {
                width: 260px;
            }
        }
            .main-content {
                flex-direction: column;
            }
            .panel-left, .panel-right {
                width: 100%;
                height: auto;
                max-height: 200px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ”„ FittingFlow</h1>
            <p>æç®€å·¥ä½œæµç¼–æ’ç³»ç»Ÿ - æ‹–æ‹½å¼ç¼–è¾‘å™¨</p>
        </div>
        
        <div class="main-content">
            <!-- å·¦ä¾§ï¼šå·¥ä½œæµåˆ—è¡¨ -->
            <div class="panel panel-left">
                <div class="section-title">å·¥ä½œæµ</div>
                <input type="text" id="newWorkflowName" class="input" placeholder="è¾“å…¥å·¥ä½œæµåç§°">
                <button class="btn btn-primary" onclick="createWorkflow()">+ åˆ›å»ºå·¥ä½œæµ</button>
                <ul class="workflow-list" id="workflowList"></ul>
            </div>
            
            <!-- ä¸­é—´ï¼šç”»å¸ƒ -->
            <div class="panel panel-center">
                <div class="toolbar">
                    <button class="btn btn-primary" onclick="runWorkflow()">â–¶ï¸ è¿è¡Œ</button>
                    <button class="btn btn-secondary" onclick="clearCanvas()">ğŸ—‘ï¸ æ¸…ç©º</button>
                </div>
                <div class="canvas" id="canvas">
                    <div class="canvas-content" id="canvasContent">
                        <svg class="connections-layer" id="connectionsLayer"></svg>
                    </div>
                    <div class="zoom-controls">
                        <button class="zoom-btn" onclick="zoomOut()">âˆ’</button>
                        <div class="zoom-level" id="zoomLevel">100%</div>
                        <button class="zoom-btn" onclick="zoomIn()">+</button>
                        <button class="zoom-btn" onclick="resetZoom()" title="é‡ç½®">âŸ²</button>
                    </div>
                </div>
                <div class="status-bar" id="statusBar">å°±ç»ª - ä»å³ä¾§æ‹–æ‹½èŠ‚ç‚¹</div>
            </div>
            
            <!-- å³ä¾§ï¼šèŠ‚ç‚¹åº“ -->
            <div class="panel panel-right">
                <div class="section-title">èŠ‚ç‚¹åº“</div>
                <div id="nodeLibrary">
                    <div class="node-template" draggable="true" data-type="start" ondragstart="dragStart(event, 'start')">
                        <div>ğŸš€ Start</div>
                        <div style="font-size:0.75rem;opacity:0.8;margin-top:4px;">èµ·å§‹èŠ‚ç‚¹</div>
                    </div>
                    <div class="node-template" draggable="true" data-type="process" ondragstart="dragStart(event, 'process')">
                        <div>âš™ï¸ Process</div>
                        <div style="font-size:0.75rem;opacity:0.8;margin-top:4px;">å¤„ç†èŠ‚ç‚¹</div>
                    </div>
                    <div class="node-template" draggable="true" data-type="python" ondragstart="dragStart(event, 'python')">
                        <div>ğŸ Python</div>
                        <div style="font-size:0.75rem;opacity:0.8;margin-top:4px;">ä»£ç æ‰§è¡Œ</div>
                    </div>
                    <div class="node-template" draggable="true" data-type="if" ondragstart="dragStart(event, 'if')">
                        <div>ğŸ”€ If/Else</div>
                        <div style="font-size:0.75rem;opacity:0.8;margin-top:4px;">æ¡ä»¶åˆ†æ”¯</div>
                    </div>
                    <div class="node-template" draggable="true" data-type="end" ondragstart="dragStart(event, 'end')">
                        <div>âœ… End</div>
                        <div style="font-size:0.75rem;opacity:0.8;margin-top:4px;">ç»“æŸèŠ‚ç‚¹</div>
                    </div>
                </div>
            </div>            
            <!-- å³ä¾§ï¼šAgent åŠ©æ‰‹ -->
            <div class="panel panel-agent">
                <div class="section-title">ğŸ¤– AI åŠ©æ‰‹</div>
                
                <div class="agent-status" id="agentStatus">
                    <div class="agent-status-dot offline" id="agentStatusDot"></div>
                    <span id="agentStatusText">æ£€æŸ¥é…ç½®ä¸­...</span>
                </div>
                
                <div class="agent-toolbar">
                    <button onclick="clearAgentChat()" title="æ¸…ç©ºå¯¹è¯">ğŸ—‘ï¸</button>
                    <button onclick="loadCurrentWorkflowContext()" title="åŠ è½½å½“å‰å·¥ä½œæµ">ğŸ“‹</button>
                    <button onclick="toggleAgentSkillHelp()" title="æŸ¥çœ‹æŠ€èƒ½å¸®åŠ©">â“</button>
                </div>
                
                <div class="agent-suggestions" id="agentSuggestions">
                    <button class="agent-suggestion" onclick="sendAgentSuggestion('å¸®æˆ‘åˆ›å»ºä¸€ä¸ªç®€å•çš„å·¥ä½œæµ')">åˆ›å»ºå·¥ä½œæµ</button>
                    <button class="agent-suggestion" onclick="sendAgentSuggestion('æ·»åŠ ä¸€ä¸ªPythonè®¡ç®—èŠ‚ç‚¹')">æ·»åŠ èŠ‚ç‚¹</button>
                    <button class="agent-suggestion" onclick="sendAgentSuggestion('è¿è¡Œå½“å‰å·¥ä½œæµ')">è¿è¡Œæµ‹è¯•</button>
                </div>
                
                <div class="agent-chat-container">
                    <div class="agent-messages" id="agentMessages">
                        <div class="agent-message system">æ¬¢è¿ä½¿ç”¨ FittingFlow AI åŠ©æ‰‹ï¼æˆ‘å¯ä»¥å¸®ä½ åˆ›å»ºå·¥ä½œæµã€æ·»åŠ èŠ‚ç‚¹ã€è¿æ¥èŠ‚ç‚¹ç­‰ã€‚</div>
                    </div>
                    
                    <div class="agent-input-area">
                        <textarea class="agent-input" id="agentInput" placeholder="è¾“å…¥ä½ çš„éœ€æ±‚ï¼Œæ¯”å¦‚ï¼šåˆ›å»ºä¸€ä¸ªè®¡ç®—ä¸¤æ•°ä¹‹å’Œçš„å·¥ä½œæµ..." onkeydown="handleAgentKeydown(event)"></textarea>
                        <button class="agent-send-btn" id="agentSendBtn" onclick="sendAgentMessage()">å‘é€</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Python ä»£ç ç¼–è¾‘å™¨æ¨¡æ€æ¡† -->
    <div class="modal-overlay" id="codeEditorModal">
        <div class="modal">
            <div class="modal-title">ğŸ Python ä»£ç ç¼–è¾‘å™¨</div>
            <textarea class="code-editor" id="codeEditor" placeholder="# åœ¨è¿™é‡Œç¼–å†™ Python ä»£ç ...
# data æ˜¯è¾“å…¥æ•°æ®å­—å…¸
# å°†ç»“æœèµ‹å€¼ç»™ output å˜é‡

output = {'result': data}"></textarea>
            <div class="modal-hint">
                ğŸ’¡ <strong>æç¤ºï¼š</strong><code>data</code> å˜é‡åŒ…å«ä¸Šæ¸¸èŠ‚ç‚¹çš„è¾“å‡ºæ•°æ®ï¼Œå°†æ‰§è¡Œç»“æœèµ‹å€¼ç»™ <code>output</code> å˜é‡å³å¯ä¼ é€’ç»™ä¸‹æ¸¸èŠ‚ç‚¹ã€‚
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeCodeEditor()">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="savePythonNode()">ä¿å­˜</button>
            </div>
        </div>
    </div>
    
    <!-- If æ¡ä»¶ç¼–è¾‘å™¨æ¨¡æ€æ¡† -->
    <div class="modal-overlay" id="ifEditorModal">
        <div class="modal">
            <div class="modal-title">ğŸ”€ æ¡ä»¶åˆ†æ”¯ç¼–è¾‘å™¨</div>
            <div style="margin-bottom: 10px;">
                <label style="font-size: 0.9rem; color: #666;">æ¡ä»¶è¡¨è¾¾å¼ï¼š</label>
                <input type="text" id="conditionInput" class="input" 
                    placeholder="data.get('score', 0) > 60" 
                    style="font-family: monospace; margin-top: 5px;">
            </div>
            <div class="modal-hint">
                ğŸ’¡ <strong>æç¤ºï¼š</strong><br>
                â€¢ <code>data</code> æ˜¯ä¸Šæ¸¸èŠ‚ç‚¹ä¼ æ¥çš„æ•°æ®å­—å…¸<br>
                â€¢ æ¡ä»¶ä¸º <strong>True</strong> æ—¶èµ°ç¬¬ä¸€ä¸ªè¿æ¥çš„åˆ†æ”¯<br>
                â€¢ æ¡ä»¶ä¸º <strong>False</strong> æ—¶èµ°ç¬¬äºŒä¸ªè¿æ¥çš„åˆ†æ”¯<br>
                â€¢ ç¤ºä¾‹ï¼š<code>data.get('score', 0) >= 60</code>ã€<code>data.get('age', 0) >= 18</code>
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeIfEditor()">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="saveIfNode()">ä¿å­˜</button>
            </div>
        </div>
    </div>
    
    <script>
        // Python èŠ‚ç‚¹ä»£ç ç¼–è¾‘å™¨
        let pendingPythonNode = null;
        
        const defaultPythonCode = `# data æ˜¯è¾“å…¥æ•°æ®å­—å…¸
# å°†ç»“æœèµ‹å€¼ç»™ output å˜é‡
# ç¤ºä¾‹ï¼š
# output = {"sum": data.get("a", 0) + data.get("b", 0)}

output = {"result": data}`;
        
        function showCodeEditor(nodeName, x, y) {
            pendingPythonNode = { name: nodeName, x, y };
            const modal = document.getElementById('codeEditorModal');
            const editor = document.getElementById('codeEditor');
            editor.value = defaultPythonCode;
            modal.classList.add('visible');
            editor.focus();
        }
        
        function closeCodeEditor() {
            const modal = document.getElementById('codeEditorModal');
            modal.classList.remove('visible');
            pendingPythonNode = null;
        }
        
        async function savePythonNode() {
            if (!pendingPythonNode) return;
            
            const code = document.getElementById('codeEditor').value;
            const { name, x, y } = pendingPythonNode;
            
            // åˆ›å»ºèŠ‚ç‚¹
            const node = {
                id: `node_${++nodeIdCounter}`,
                name: name,
                type: 'python',
                x: x,
                y: y,
                code: code
            };
            nodes.push(node);
            renderOneNode(node);
            
            // å‘é€åˆ°åç«¯
            if (currentWorkflow) {
                try {
                    await fetch(`/workflows/${encodeURIComponent(currentWorkflow)}/nodes`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            workflow_name: currentWorkflow,
                            node_name: name,
                            node_type: 'python',
                            code: code,
                            config: { node_type: 'python', code: code }
                        })
                    });
                } catch (e) {
                    console.error('Failed to add Python node to backend:', e);
                }
            }
            
            closeCodeEditor();
            setStatus(`âœ… Python èŠ‚ç‚¹å·²æ·»åŠ : ${name}`);
        }
        
        // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
        document.getElementById('codeEditorModal').onclick = (e) => {
            if (e.target.id === 'codeEditorModal') {
                closeCodeEditor();
            }
        };
        
        // If èŠ‚ç‚¹æ¡ä»¶ç¼–è¾‘å™¨
        let pendingIfNode = null;
        
        function showIfEditor(nodeName, x, y) {
            pendingIfNode = { name: nodeName, x, y };
            const modal = document.getElementById('ifEditorModal');
            const input = document.getElementById('conditionInput');
            input.value = '';
            modal.classList.add('visible');
            input.focus();
        }
        
        function closeIfEditor() {
            const modal = document.getElementById('ifEditorModal');
            modal.classList.remove('visible');
            pendingIfNode = null;
        }
        
        async function saveIfNode() {
            if (!pendingIfNode) return;
            
            const condition = document.getElementById('conditionInput').value.trim() || 'True';
            const { name, x, y } = pendingIfNode;
            
            // åˆ›å»ºèŠ‚ç‚¹
            const node = {
                id: `node_${++nodeIdCounter}`,
                name: name,
                type: 'if',
                x: x,
                y: y,
                condition: condition
            };
            nodes.push(node);
            renderOneNode(node);
            
            // å‘é€åˆ°åç«¯
            if (currentWorkflow) {
                try {
                    await fetch(`/workflows/${encodeURIComponent(currentWorkflow)}/nodes`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            workflow_name: currentWorkflow,
                            node_name: name,
                            node_type: 'if',
                            condition: condition,
                            config: { node_type: 'if', condition: condition }
                        })
                    });
                } catch (e) {
                    console.error('Failed to add If node to backend:', e);
                }
            }
            
            closeIfEditor();
            setStatus(`âœ… æ¡ä»¶åˆ†æ”¯èŠ‚ç‚¹å·²æ·»åŠ : ${name} (æ¡ä»¶: ${condition})`);
        }
        
        document.getElementById('ifEditorModal').onclick = (e) => {
            if (e.target.id === 'ifEditorModal') {
                closeIfEditor();
            }
        };
        
        let currentWorkflow = null;
        let workflows = [];
        let nodes = [];
        let connections = [];
        let selectedNode = null;
        let nodeIdCounter = 0;
        
        let draggingNode = null;
        let dragOffset = { x: 0, y: 0 };
        
        let connecting = false;
        let connectFrom = null;
        
        // ç”»å¸ƒå¹³ç§»å’Œç¼©æ”¾çŠ¶æ€
        let canvasState = {
            scale: 1,
            panX: 0,
            panY: 0,
            isPanning: false,
            panStartX: 0,
            panStartY: 0
        };
        
        // åˆå§‹åŒ–
        init();
        
        async function init() {
            await fetchWorkflows();
            
            // å…¨å±€äº‹ä»¶
            const canvas = document.getElementById('canvas');
            const canvasContent = document.getElementById('canvasContent');
            
            canvas.ondragover = (e) => {
                e.preventDefault();
                canvas.style.backgroundColor = '#e8f0fe';
            };
            canvas.ondragleave = () => {
                canvas.style.backgroundColor = '';
            };
            canvas.ondrop = drop;
            canvas.onclick = (e) => {
                // åªæœ‰ç‚¹å‡»ç”»å¸ƒæœ¬èº«æ—¶æ‰å–æ¶ˆé€‰æ‹©ï¼Œä¸ç‚¹å‡»èŠ‚ç‚¹æˆ–è¿çº¿
                if (e.target.id === 'canvas' || e.target.id === 'canvasContent') {
                    deselectAll();
                }
            };
            
            // æ»šè½®ç¼©æ”¾
            canvas.onwheel = (e) => {
                e.preventDefault();
                const delta = e.deltaY > 0 ? 0.9 : 1.1;
                const newScale = Math.max(0.3, Math.min(3, canvasState.scale * delta));
                
                // ä»¥é¼ æ ‡ä½ç½®ä¸ºä¸­å¿ƒç¼©æ”¾
                const rect = canvas.getBoundingClientRect();
                const mouseX = e.clientX - rect.left;
                const mouseY = e.clientY - rect.top;
                
                const scaleRatio = newScale / canvasState.scale;
                canvasState.panX = mouseX - (mouseX - canvasState.panX) * scaleRatio;
                canvasState.panY = mouseY - (mouseY - canvasState.panY) * scaleRatio;
                canvasState.scale = newScale;
                
                updateCanvasTransform();
            };
            
            // ç”»å¸ƒå¹³ç§»ï¼ˆç©ºæ ¼+æ‹–åŠ¨ æˆ– ä¸­é”®æ‹–åŠ¨ï¼‰
            canvas.onmousedown = (e) => {
                if (e.button === 1 || (e.button === 0 && e.code === 'Space')) {
                    // ä¸­é”®æˆ–ç©ºæ ¼é”®+å·¦é”®
                    e.preventDefault();
                    canvasState.isPanning = true;
                    canvasState.panStartX = e.clientX - canvasState.panX;
                    canvasState.panStartY = e.clientY - canvasState.panY;
                    canvas.classList.add('panning');
                }
            };
            
            document.onmousemove = onMouseMove;
            document.onmouseup = onMouseUp;
            
            // ç©ºæ ¼é”®ç›‘å¬
            document.onkeydown = (e) => {
                if (e.code === 'Space' && !e.repeat && e.target === document.body) {
                    canvas.style.cursor = 'grab';
                }
            };
            document.onkeyup = (e) => {
                if (e.code === 'Space') {
                    canvas.style.cursor = 'grab';
                    canvas.classList.remove('panning');
                }
            };
        }
        
        // ========== å·¥ä½œæµç®¡ç† ==========
        async function fetchWorkflows() {
            try {
                const res = await fetch('/workflows');
                const data = await res.json();
                workflows = data.workflows;
                renderWorkflowList();
            } catch (e) {}
        }
        
        function renderWorkflowList() {
            const list = document.getElementById('workflowList');
            list.innerHTML = workflows.map(wf => `
                <li class="workflow-item ${currentWorkflow === wf.name ? 'active' : ''}" onclick="loadWorkflow('${wf.name}')">
                    ${wf.name}
                </li>
            `).join('');
        }
        
        async function createWorkflow() {
            const name = document.getElementById('newWorkflowName').value.trim();
            if (!name) {
                setStatus('âŒ è¯·è¾“å…¥å·¥ä½œæµåç§°');
                return;
            }
            
            try {
                const res = await fetch('/workflows', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name })
                });
                
                if (!res.ok) {
                    const err = await res.json();
                    throw new Error(err.detail || 'åˆ›å»ºå¤±è´¥');
                }
                
                document.getElementById('newWorkflowName').value = '';
                await fetchWorkflows();
                loadWorkflow(name);
                setStatus('âœ… å·¥ä½œæµåˆ›å»ºæˆåŠŸ');
            } catch (e) {
                setStatus('âŒ ' + e.message);
                console.error(e);
            }
        }
        
        async function loadWorkflow(name) {
            currentWorkflow = name;
            renderWorkflowList();
            clearCanvas();
            resetZoom(); // é‡ç½®ç”»å¸ƒè§†å›¾
            
            try {
                const res = await fetch(`/workflows/${encodeURIComponent(name)}`);
                if (!res.ok) throw new Error('Failed to load');
                const wf = await res.json();
                
                // æ­£ç¡®è§£æ edges - åç«¯è¿”å›çš„æ˜¯ {source, target} æ ¼å¼
                connections = (wf.edges || []).map(e => ({
                    source: e.source,
                    target: e.target
                }));
                
                // é‡ç½®èŠ‚ç‚¹ ID è®¡æ•°å™¨
                nodeIdCounter = 0;
                
                // å»ºç«‹èŠ‚ç‚¹åç§°åˆ°IDçš„æ˜ å°„ï¼Œä½¿ç”¨èŠ‚ç‚¹åç§°ä½œä¸ºID
                const nameToIdMap = {};
                
                wf.nodes.forEach((node, i) => {
                    const nodeType = node.config?.node_type || node.config?._node_type || 'basic';
                    // ä½¿ç”¨èŠ‚ç‚¹åç§°ä½œä¸ºIDï¼Œè¿™æ ·ä¸edgesä¸­çš„source/targetä¸€è‡´
                    nameToIdMap[node.name] = node.name;
                    addNode(node.name, nodeType, 50 + i * 200, 100, node.name);
                });
                
                // å°†edgesä¸­çš„èŠ‚ç‚¹åç§°è½¬æ¢ä¸ºID
                connections = (wf.edges || []).map(e => ({
                    source: nameToIdMap[e.source] || e.source,
                    target: nameToIdMap[e.target] || e.target
                }));
                
                renderConnections();
                setStatus(`âœ… å·²åŠ è½½: ${name} (${wf.nodes.length} ä¸ªèŠ‚ç‚¹)`);
            } catch (e) {
                setStatus('âŒ åŠ è½½å¤±è´¥: ' + e.message);
                console.error(e);
            }
        }
        
        // ========== æ‹–æ‹½èŠ‚ç‚¹ ==========
        function dragStart(e, type) {
            e.dataTransfer.setData('type', type);
        }
        
        function drop(e) {
            e.preventDefault();
            const canvas = document.getElementById('canvas');
            canvas.style.backgroundColor = '';
            
            const type = e.dataTransfer.getData('type');
            if (!type) return;
            
            const rect = canvas.getBoundingClientRect();
            // è€ƒè™‘ç¼©æ”¾å’Œå¹³ç§»
            const x = (e.clientX - rect.left - canvasState.panX) / canvasState.scale - 75;
            const y = (e.clientY - rect.top - canvasState.panY) / canvasState.scale - 30;
            
            const name = `${type}_${++nodeIdCounter}`;
            
            // Python èŠ‚ç‚¹éœ€è¦ç¼–è¾‘ä»£ç 
            if (type === 'python') {
                showCodeEditor(name, x, y);
            } else if (type === 'if') {
                // If èŠ‚ç‚¹éœ€è¦ç¼–è¾‘æ¡ä»¶
                showIfEditor(name, x, y);
            } else {
                addNode(name, type, x, y);
                if (currentWorkflow) {
                    addNodeToBackend(name, type);
                }
            }
            
            setStatus(`âœ… å·²æ·»åŠ : ${name}`);
        }
        
        function addNode(name, type, x, y, existingId = null) {
            const node = {
                id: existingId || name,  // ä½¿ç”¨nameä½œä¸ºIDï¼Œä¿æŒä¸€è‡´æ€§
                name: name,
                type: type,
                x: x,
                y: y
            };
            nodes.push(node);
            renderOneNode(node);
        }
        
        function renderOneNode(node) {
            const canvasContent = document.getElementById('canvasContent');
            
            const el = document.createElement('div');
            el.className = 'workflow-node';
            el.id = node.id;
            el.style.left = node.x + 'px';
            el.style.top = node.y + 'px';
            
            el.innerHTML = `
                <div class="node-header">
                    <span class="node-title">${node.name}</span>
                    <button class="node-delete">Ã—</button>
                </div>
                <div class="node-body">
                    <div class="node-type-label">${node.type}</div>
                </div>
                <div class="port port-input"></div>
                <div class="port port-output"></div>
            `;
            
            // åˆ é™¤æŒ‰é’®
            el.querySelector('.node-delete').onclick = (e) => {
                e.stopPropagation();
                removeNode(node.id);
            };
            
            // é€‰æ‹©èŠ‚ç‚¹
            el.onclick = (e) => {
                if (e.target.classList.contains('port') || e.target.classList.contains('node-delete')) return;
                e.stopPropagation();
                selectNode(node.id);
            };
            
            // æ‹–æ‹½ç§»åŠ¨
            el.onmousedown = (e) => {
                if (e.target.classList.contains('port') || e.target.classList.contains('node-delete')) return;
                draggingNode = node;
                const nodeRect = el.getBoundingClientRect();
                const canvasRect = document.getElementById('canvas').getBoundingClientRect();
                dragOffset = {
                    x: e.clientX - nodeRect.left,
                    y: e.clientY - nodeRect.top
                };
                selectNode(node.id);
            };
            
            // è¿æ¥ç«¯å£
            el.querySelector('.port-output').onmousedown = (e) => {
                e.stopPropagation();
                connecting = true;
                connectFrom = node;
            };
            
            canvasContent.appendChild(el);
        }
        
        function selectNode(id) {
            deselectAll();
            selectedNode = nodes.find(n => n.id === id);
            if (selectedNode) {
                document.getElementById(id).classList.add('selected');
            }
        }
        
        function deselectAll() {
            document.querySelectorAll('.workflow-node').forEach(el => el.classList.remove('selected'));
            selectedNode = null;
        }
        
        function removeNode(id) {
            nodes = nodes.filter(n => n.id !== id);
            connections = connections.filter(c => c.source !== id && c.target !== id);
            const el = document.getElementById(id);
            if (el) el.remove();
            renderConnections();
            setStatus('âœ… èŠ‚ç‚¹å·²åˆ é™¤');
        }
        
        // ========== é¼ æ ‡ç§»åŠ¨ ==========
        function onMouseMove(e) {
            const canvas = document.getElementById('canvas');
            const canvasContent = document.getElementById('canvasContent');
            const rect = canvas.getBoundingClientRect();
            
            // ç”»å¸ƒå¹³ç§»
            if (canvasState.isPanning) {
                canvasState.panX = e.clientX - canvasState.panStartX;
                canvasState.panY = e.clientY - canvasState.panStartY;
                updateCanvasTransform();
                return;
            }
            
            if (draggingNode) {
                // è€ƒè™‘ç¼©æ”¾å’Œåç§»
                const x = (e.clientX - rect.left - dragOffset.x - canvasState.panX) / canvasState.scale;
                const y = (e.clientY - rect.top - dragOffset.y - canvasState.panY) / canvasState.scale;
                draggingNode.x = x;
                draggingNode.y = y;
                
                const el = document.getElementById(draggingNode.id);
                el.style.left = x + 'px';
                el.style.top = y + 'px';
                
                renderConnections();
            }
            
            if (connecting) {
                const svg = document.getElementById('connectionsLayer');
                let tempLine = svg.querySelector('.temp-line');
                if (!tempLine) {
                    tempLine = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                    tempLine.classList.add('temp-line');
                    tempLine.setAttribute('fill', 'none');
                    tempLine.setAttribute('stroke', '#999');
                    tempLine.setAttribute('stroke-width', '2');
                    tempLine.setAttribute('stroke-dasharray', '5,5');
                    svg.appendChild(tempLine);
                }
                
                // ä½¿ç”¨ä¸ renderConnections ä¸€è‡´çš„åæ ‡è®¡ç®—æ–¹å¼
                const x1 = connectFrom.x + 150; // èŠ‚ç‚¹å³è¾¹ç¼˜
                const y1 = connectFrom.y + 35;  // èŠ‚ç‚¹ä¸­éƒ¨
                const x2 = (e.clientX - rect.left - canvasState.panX) / canvasState.scale;
                const y2 = (e.clientY - rect.top - canvasState.panY) / canvasState.scale;
                
                tempLine.setAttribute('d', bezier(x1, y1, x2, y2));
            }
        }
        
        function onMouseUp(e) {
            if (draggingNode) {
                draggingNode = null;
            }
            
            if (canvasState.isPanning) {
                canvasState.isPanning = false;
                canvas.classList.remove('panning');
            }
            
            if (connecting) {
                const svg = document.getElementById('connectionsLayer');
                const temp = svg.querySelector('.temp-line');
                if (temp) temp.remove();
                
                const target = e.target;
                if (target.classList.contains('port-input')) {
                    const targetNodeEl = target.closest('.workflow-node');
                    if (targetNodeEl && targetNodeEl.id !== connectFrom.id) {
                        addConnection(connectFrom.id, targetNodeEl.id);
                        if (currentWorkflow) {
                            const fromName = nodes.find(n => n.id === connectFrom.id).name;
                            const toName = nodes.find(n => n.id === targetNodeEl.id).name;
                            connectNodesBackend(fromName, toName);
                        }
                    }
                }
                
                connecting = false;
                connectFrom = null;
            }
        }
        
        // ========== è¿çº¿ ==========
        function addConnection(fromId, toId) {
            const exists = connections.some(c => c.source === fromId && c.target === toId);
            if (exists) return;
            
            connections.push({ source: fromId, target: toId });
            renderConnections();
            setStatus('âœ… å·²è¿æ¥');
        }
        
        function renderConnections() {
            const svg = document.getElementById('connectionsLayer');
            
            const temp = svg.querySelector('.temp-line');
            svg.innerHTML = '';
            if (temp) svg.appendChild(temp);
            
            connections.forEach((conn, i) => {
                const fromNode = nodes.find(n => n.id === conn.source);
                const toNode = nodes.find(n => n.id === conn.target);
                if (!fromNode || !toNode) return;
                
                const fromEl = document.getElementById(fromNode.id);
                const toEl = document.getElementById(toNode.id);
                if (!fromEl || !toEl) return;
                
                // ç›´æ¥ä½¿ç”¨èŠ‚ç‚¹å­˜å‚¨çš„åæ ‡è®¡ç®—è¿æ¥ç‚¹
                const x1 = fromNode.x + 150; // èŠ‚ç‚¹å³è¾¹ç¼˜ï¼ˆmin-width: 150pxï¼‰
                const y1 = fromNode.y + 35;  // èŠ‚ç‚¹ä¸­éƒ¨ï¼ˆheader+body ~70px çš„ä¸€åŠï¼‰
                const x2 = toNode.x;         // èŠ‚ç‚¹å·¦è¾¹ç¼˜
                const y2 = toNode.y + 35;
                
                const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                path.setAttribute('class', 'connection-line');
                path.setAttribute('d', bezier(x1, y1, x2, y2));
                path.setAttribute('data-source', conn.source);
                path.setAttribute('data-target', conn.target);
                path.onclick = (e) => {
                    e.stopPropagation();
                    if (confirm('åˆ é™¤è¿çº¿ï¼Ÿ')) {
                        const src = path.getAttribute('data-source');
                        const tgt = path.getAttribute('data-target');
                        connections = connections.filter(c => !(c.source === src && c.target === tgt));
                        renderConnections();
                    }
                };
                svg.appendChild(path);
            });
        }
        
        function bezier(x1, y1, x2, y2) {
            const dx = Math.abs(x2 - x1) * 0.5;
            return `M ${x1} ${y1} C ${x1 + dx} ${y1}, ${x2 - dx} ${y2}, ${x2} ${y2}`;
        }
        
        // ========== åç«¯åŒæ­¥ ==========
        async function addNodeToBackend(name, type, code = null) {
            if (!currentWorkflow) return;
            try {
                const body = {
                    workflow_name: currentWorkflow,
                    node_name: name,
                    node_type: type,
                    config: { node_type: type, ...(code && { code }) }
                };
                if (code) {
                    body.code = code;
                }
                await fetch(`/workflows/${encodeURIComponent(currentWorkflow)}/nodes`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });
            } catch (e) {}
        }
        
        async function connectNodesBackend(source, target) {
            if (!currentWorkflow) return;
            try {
                await fetch(`/workflows/${currentWorkflow}/connect`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        workflow_name: currentWorkflow,
                        source_node: source,
                        target_node: target
                    })
                });
            } catch (e) {}
        }
        
        // ========== å…¶ä»– ==========
        async function runWorkflow() {
            if (!currentWorkflow) {
                setStatus('âŒ è¯·å…ˆé€‰æ‹©å·¥ä½œæµ');
                return;
            }
            
            setStatus('â³ è¿è¡Œä¸­...');
            try {
                const res = await fetch(`/workflows/${currentWorkflow}/run`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ workflow_name: currentWorkflow, input_data: {} })
                });
                const result = await res.json();
                setStatus('âœ… è¿è¡Œå®Œæˆ\n' + JSON.stringify(result, null, 2));
            } catch (e) {
                setStatus('âŒ è¿è¡Œå¤±è´¥');
            }
        }
        
        function clearCanvas() {
            nodes = [];
            connections = [];
            selectedNode = null;
            const canvasContent = document.getElementById('canvasContent');
            // åªæ¸…ç©ºå†…å®¹ï¼Œä¿ç•™ç»“æ„
            while (canvasContent.firstChild) {
                canvasContent.removeChild(canvasContent.firstChild);
            }
            // é‡æ–°åˆ›å»º SVG å±‚
            const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
            svg.className = 'connections-layer';
            svg.id = 'connectionsLayer';
            canvasContent.appendChild(svg);
        }
        
        // ========== ç”»å¸ƒå˜æ¢æ§åˆ¶ ==========
        function updateCanvasTransform() {
            const canvasContent = document.getElementById('canvasContent');
            canvasContent.style.transform = `translate(${canvasState.panX}px, ${canvasState.panY}px) scale(${canvasState.scale})`;
            document.getElementById('zoomLevel').textContent = Math.round(canvasState.scale * 100) + '%';
        }
        
        function zoomIn() {
            canvasState.scale = Math.min(3, canvasState.scale * 1.2);
            updateCanvasTransform();
        }
        
        function zoomOut() {
            canvasState.scale = Math.max(0.3, canvasState.scale / 1.2);
            updateCanvasTransform();
        }
        
        function resetZoom() {
            canvasState.scale = 1;
            canvasState.panX = 0;
            canvasState.panY = 0;
            updateCanvasTransform();
        }
        
        function setStatus(msg) {
            document.getElementById('statusBar').textContent = msg;
        }

        // ========== Agent åŠ©æ‰‹åŠŸèƒ½ ==========
        let agentMessages = [];
        let isAgentConfigured = false;
        let currentWorkflowContext = '';

        // æ£€æŸ¥ Agent é…ç½®çŠ¶æ€
        async function checkAgentStatus() {
            try {
                const res = await fetch('/agent/status');
                const data = await res.json();
                isAgentConfigured = data.configured;

                const dot = document.getElementById('agentStatusDot');
                const text = document.getElementById('agentStatusText');

                if (isAgentConfigured) {
                    dot.className = 'agent-status-dot online';
                    text.textContent = `å·²è¿æ¥ (${data.model})`;
                } else {
                    dot.className = 'agent-status-dot offline';
                    text.textContent = 'æœªé…ç½® (è¯·è®¾ç½® AGENT_API_KEY)';
                }
            } catch (e) {
                const dot = document.getElementById('agentStatusDot');
                const text = document.getElementById('agentStatusText');
                dot.className = 'agent-status-dot offline';
                text.textContent = 'æœåŠ¡ä¸å¯ç”¨';
            }
        }

        // å‘é€ Agent æ¶ˆæ¯
        async function sendAgentMessage() {
            const input = document.getElementById('agentInput');
            const btn = document.getElementById('agentSendBtn');
            const message = input.value.trim();

            if (!message) return;
            if (!isAgentConfigured) {
                addAgentMessage('è¯·å…ˆé…ç½® AGENT_API_KEY ç¯å¢ƒå˜é‡', 'error');
                return;
            }

            // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
            addAgentMessage(message, 'user');
            input.value = '';
            btn.disabled = true;

            // æ˜¾ç¤ºè¾“å…¥ä¸­çŠ¶æ€
            showAgentTyping();

            try {
                const res = await fetch('/agent/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        messages: [...agentMessages.map(m => ({ role: m.role, content: m.content })),
                            { role: 'user', content: message }
                        ],
                        workflow_context: currentWorkflowContext,
                        stream: false
                    })
                });

                hideAgentTyping();

                if (!res.ok) {
                    const error = await res.json();
                    addAgentMessage(`é”™è¯¯: ${error.detail || 'è¯·æ±‚å¤±è´¥'}`, 'error');
                    return;
                }

                const data = await res.json();

                // å¤„ç†å“åº”
                for (const resp of data.responses) {
                    if (resp.content) {
                        addAgentMessage(resp.content, 'assistant');
                    }
                    if (resp.tool_result) {
                        const { tool, params, result } = resp.tool_result;
                        handleAgentToolResult(tool, params, result);
                    }
                    if (resp.error) {
                        addAgentMessage(`é”™è¯¯: ${resp.error}`, 'error');
                    }
                }

                // ä¿å­˜å¯¹è¯å†å²
                agentMessages.push({ role: 'user', content: message });
                if (data.responses[0]?.content) {
                    agentMessages.push({ role: 'assistant', content: data.responses[0].content });
                }

            } catch (e) {
                hideAgentTyping();
                addAgentMessage(`è¯·æ±‚å¤±è´¥: ${e.message}`, 'error');
            } finally {
                btn.disabled = false;
            }
        }

        // å¤„ç†å·¥å…·è°ƒç”¨ç»“æœ
        function handleAgentToolResult(tool, params, result) {
            if (result.error) {
                addAgentMessage(`å·¥å…·æ‰§è¡Œå¤±è´¥: ${result.error}`, 'error');
                return;
            }

            // æ ¹æ®å·¥å…·ç±»å‹æ‰§è¡Œç›¸åº”æ“ä½œ
            switch (tool) {
                case 'create_workflow':
                    addAgentMessage(`âœ… å·²åˆ›å»ºå·¥ä½œæµ: ${params.name}`, 'system');
                    loadWorkflowList();
                    break;
                case 'add_node':
                    addAgentMessage(`âœ… å·²æ·»åŠ èŠ‚ç‚¹: ${params.node_name} (${params.node_type})`, 'system');
                    if (currentWorkflow && currentWorkflow === params.workflow_name) {
                        // åˆ·æ–°å½“å‰å·¥ä½œæµè§†å›¾
                        loadWorkflow(currentWorkflow);
                    }
                    break;
                case 'connect_nodes':
                    addAgentMessage(`âœ… å·²è¿æ¥èŠ‚ç‚¹: ${params.source_node} â†’ ${params.target_node}`, 'system');
                    if (currentWorkflow) {
                        loadWorkflow(currentWorkflow);
                    }
                    break;
                case 'run_workflow':
                    addAgentMessage(`âœ… å·¥ä½œæµè¿è¡Œå®Œæˆ`, 'system');
                    // æ˜¾ç¤ºè¿è¡Œç»“æœ
                    if (result.result || result.final_output) {
                        const output = JSON.stringify(result.result || result.final_output, null, 2);
                        addAgentMessage(`è¾“å‡º:\n\`\`\`json\n${output}\n\`\`\``, 'assistant');
                    }
                    break;
                default:
                    addAgentMessage(`âœ… å·¥å…·æ‰§è¡ŒæˆåŠŸ: ${tool}`, 'system');
            }
        }

        // æ·»åŠ æ¶ˆæ¯åˆ°å¯¹è¯
        function addAgentMessage(content, role) {
            const container = document.getElementById('agentMessages');
            const msg = document.createElement('div');
            msg.className = `agent-message ${role}`;
            msg.innerHTML = formatAgentMessage(content);
            container.appendChild(msg);
            container.scrollTop = container.scrollHeight;
        }

        // æ ¼å¼åŒ–æ¶ˆæ¯å†…å®¹ï¼ˆç®€å•çš„ markdown æ”¯æŒï¼‰
        function formatAgentMessage(content) {
            return content
                .replace(/\n/g, '<br>')
                .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
                .replace(/\`\`\`(\w+)?\n([\s\S]+?)\`\`\`/g, '<pre><code>$2</code></pre>')
                .replace(/`(.+?)`/g, '<code>$1</code>');
        }

        // æ˜¾ç¤ºè¾“å…¥ä¸­
        function showAgentTyping() {
            const container = document.getElementById('agentMessages');
            const typing = document.createElement('div');
            typing.className = 'agent-typing';
            typing.id = 'agentTyping';
            typing.innerHTML = `
                <div class="agent-typing-dot"></div>
                <div class="agent-typing-dot"></div>
                <div class="agent-typing-dot"></div>
            `;
            container.appendChild(typing);
            container.scrollTop = container.scrollHeight;
        }

        // éšè—è¾“å…¥ä¸­
        function hideAgentTyping() {
            const typing = document.getElementById('agentTyping');
            if (typing) typing.remove();
        }

        // å‘é€å»ºè®®
        function sendAgentSuggestion(text) {
            document.getElementById('agentInput').value = text;
            sendAgentMessage();
        }

        // æ¸…ç©ºå¯¹è¯
        function clearAgentChat() {
            agentMessages = [];
            const container = document.getElementById('agentMessages');
            container.innerHTML = '<div class="agent-message system">å¯¹è¯å·²æ¸…ç©º</div>';
        }

        // åŠ è½½å½“å‰å·¥ä½œæµä¸Šä¸‹æ–‡
        async function loadCurrentWorkflowContext() {
            if (!currentWorkflow) {
                addAgentMessage('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªå·¥ä½œæµ', 'error');
                return;
            }

            try {
                const res = await fetch(`/workflows/${encodeURIComponent(currentWorkflow)}`);
                const wf = await res.json();

                currentWorkflowContext = JSON.stringify(wf, null, 2);
                addAgentMessage(`å·²åŠ è½½å·¥ä½œæµ "${currentWorkflow}" çš„ä¸Šä¸‹æ–‡`, 'system');

                // æ˜¾ç¤ºç®€è¦ä¿¡æ¯
                const nodeCount = wf.nodes ? wf.nodes.length : 0;
                const edgeCount = wf.edges ? wf.edges.length : 0;
                addAgentMessage(`å·¥ä½œæµåŒ…å« ${nodeCount} ä¸ªèŠ‚ç‚¹, ${edgeCount} æ¡è¿æ¥`, 'assistant');

            } catch (e) {
                addAgentMessage(`åŠ è½½å¤±è´¥: ${e.message}`, 'error');
            }
        }

        // æ˜¾ç¤º/éšè—æŠ€èƒ½å¸®åŠ©
        function toggleAgentSkillHelp() {
            const helpText = `
**AI åŠ©æ‰‹å¯ä»¥å¸®ä½ ï¼š**

â€¢ åˆ›å»ºå·¥ä½œæµ
â€¢ æ·»åŠ å„ç§ç±»å‹çš„èŠ‚ç‚¹
â€¢ è¿æ¥èŠ‚ç‚¹æ„å»ºæµç¨‹
â€¢ è¿è¡Œå’Œè°ƒè¯•å·¥ä½œæµ

**ç¤ºä¾‹æŒ‡ä»¤ï¼š**
- "åˆ›å»ºä¸€ä¸ªè®¡ç®—ä¸¤æ•°ä¹‹å’Œçš„å·¥ä½œæµ"
- "æ·»åŠ ä¸€ä¸ªPythonèŠ‚ç‚¹ï¼Œè®¡ç®—å¹³å‡å€¼"
- "è¿æ¥ start èŠ‚ç‚¹åˆ° process èŠ‚ç‚¹"
- "è¿è¡Œå½“å‰å·¥ä½œæµ"
            `;
            addAgentMessage(helpText, 'assistant');
        }

        // å¤„ç†é”®ç›˜äº‹ä»¶
        function handleAgentKeydown(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendAgentMessage();
            }
        }

        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥ Agent çŠ¶æ€
        document.addEventListener('DOMContentLoaded', () => {
            checkAgentStatus();
        });
    </script>
</body>
</html>
